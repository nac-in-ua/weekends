name: Playwright Tests

on: [deployment_status]

# jobs:
#   install:
#     timeout-minutes: 60
#     name: üîç Install
#     runs-on: ubuntu-latest
#     if: github.event.deployment_status.state == 'success'
#     steps:
#       - uses: actions/checkout@v3
#       - uses: actions/setup-node@v3
#         with:
#           node-version: '16.x'

#       - name: Cache node_modules
#         uses: actions/cache@v3
#         id: cache-node-modules
#         with:
#           path: |
#             node_modules
#           key: modules-${{ hashFiles('package-lock.json') }}

#       - name: Cache Playwright binaries
#         uses: actions/cache@v3
#         id: cache-playwright
#         with:
#           path: |
#             ~/.cache/ms-playwright
#           key: playwright-${{ hashFiles('package-lock.json') }}
#           restore-keys: |
#             playwright-

#       - name: Install dependencies
#         if: steps.cache-node-modules.outputs.cache-hit != 'true'
#         run: npm ci

#       - name: Install Playwright Browsers
#         if: steps.cache-playwright.outputs.cache-hit != 'true'
#         run: npx playwright install --with-deps

#   test-chrome:
#     strategy:
#       fail-fast: false
#       matrix:
#         shard: [1, 2, 3, 4]
#     timeout-minutes: 60
#     name: üß™ Chrome (${{ matrix.shard }}/${{ strategy.job-total }} }})
#     if: ${{ github.event.deployment_status.state == 'success' }}
#     runs-on: ubuntu-latest
#     needs: install
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v3
#       - uses: actions/setup-node@v3
#         with:
#           node-version: '16.x'

#       - name: Cache node_modules
#         uses: actions/cache@v3
#         with:
#           path: |
#             node_modules
#           key: modules-${{ hashFiles('package-lock.json') }}

#       - name: Cache Playwright
#         uses: actions/cache@v3
#         with:
#           path: |
#             ~/.cache/ms-playwright
#           key: playwright-${{ hashFiles('package-lock.json') }}

#       - name: Run Playwright tests
#         run: npm run test:e2e:chromium -- --shard=${{ matrix.shard }}/${{ strategy.job-total }}
#         env:
#           SITE_URL: ${{ github.event.deployment_status.target_url }}

#       - uses: actions/upload-artifact@v3
#         if: always()
#         with:
#           name: playwright-report-${{ matrix.shard }}_${{ strategy.job-total }}
#           path: playwright-report
#           if-no-files-found: error
#           retention-days: 30

  # test-firefox:
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       shard: [1, 2, 3, 4]
  #   timeout-minutes: 60
  #   name: üß™ Firefox (${{ matrix.shard }}/${{ strategy.job-total }} }})
  #   if: ${{ github.event.deployment_status.state == 'success' }}
  #   runs-on: ubuntu-latest
  #   needs: install
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3

  #     - name: Cache node_modules
  #       uses: actions/cache@v3
  #       with:
  #         path: |
  #           node_modules
  #         key: modules-${{ hashFiles('package-lock.json') }}

  #     - name: Cache Playwright
  #       uses: actions/cache@v3
  #       with:
  #         path: |
  #           ~/.cache/ms-playwright
  #         key: playwright-${{ hashFiles('package-lock.json') }}

  #     - name: Run Playwright tests
  #       run: npm run test:e2e:firefox -- --shard=${{ matrix.shard }}/${{ strategy.job-total }}
  #       env:
  #         SITE_URL: ${{ github.event.deployment_status.target_url }}

  #     - uses: actions/upload-artifact@v3
  #       if: always()
  #       with:
  #         name: playwright-report-${{ matrix.shard }}_${{ strategy.job-total }}
  #         path: playwright-report
  #         if-no-files-found: error
  #         retention-days: 30

  # test-webkit:
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       shard: [1, 2, 3, 4]
  #   timeout-minutes: 60
  #   name: üß™ Webkit (${{ matrix.shard }}/${{ strategy.job-total }} }})
  #   if: ${{ github.event.deployment_status.state == 'success' }}
  #   runs-on: ubuntu-latest
  #   needs: install
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3

  #     - name: Cache node_modules
  #       uses: actions/cache@v3
  #       with:
  #         path: |
  #           node_modules
  #         key: modules-${{ hashFiles('package-lock.json') }}

  #     - name: Cache Playwright
  #       uses: actions/cache@v3
  #       with:
  #         path: |
  #           ~/.cache/ms-playwright
  #         key: playwright-${{ hashFiles('package-lock.json') }}

  #     - name: Run Playwright tests
  #       run: npm run test:e2e:webkit -- --shard=${{ matrix.shard }}/${{ strategy.job-total }}
  #       env:
  #         SITE_URL: ${{ github.event.deployment_status.target_url }}

  #     - uses: actions/upload-artifact@v3
  #       if: always()
  #       with:
  #         name: playwright-report-${{ matrix.shard }}_${{ strategy.job-total }}
  #         path: playwright-report
  #         if-no-files-found: error
  #         retention-days: 30


jobs:
  install:
    timeout-minutes: 60
    name: üîç Install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3

      - name: Cache node_modules
        uses: actions/cache@v3
        id: cache-node-modules
        with:
          path: |
            node_modules
          key: modules-${{ hashFiles('package-lock.json') }}

      - name: Cache Playwright binaries
        uses: actions/cache@v3
        id: cache-playwright
        with:
          path: |
            ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: Install Playwright Browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps

  test:
    name: üß™ Test (${{ matrix.shard }}/${{ strategy.job-total }})
    needs: install
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3

      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
          key: modules-${{ hashFiles('package-lock.json') }}

      - name: Cache Playwright
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('package-lock.json') }}

      - name: Run Playwright tests
        run: npx playwright test --shard=${{ matrix.shard }}/${{ strategy.job-total }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report-${{ matrix.shard }}_${{ strategy.job-total }}
          path: playwright-report
          retention-days: 30